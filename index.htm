<!DOCTYPE html>
<html>
	<head>
		<title>GitHub Game Off 2012</title>

		<script type="text/javascript">
			var cellWidth = 16;
			var cellHeight = 16;
			var cellsH = 16;
			var cellsV = 16;
			var borderWidth = 16;

			function getWidth() {
				return cellWidth * cellsH;
			}
			function getHeight() {
				return cellHeight * cellsV;
			}
		</script>

		<link rel="stylesheet/less" type="text/less" href="style.less">
		<script type="text/javascript" src="less.js"></script>

		<script type="text/javascript" src="jquery.js"></script>
		<script type="text/javascript" src="input.js"></script>
		<script type="text/javascript" src="bot.js"></script>
	</head>
	<body>
		<div id="container">
			<div id="arena">
				<div id="border-tl"></div><div id="border-t"></div><div id="border-tr"></div>
				<div id="border-l"></div><canvas id="gameCanvas"></canvas><div id="border-r"></div>
				<div id="border-bl"></div><div id="border-b"></div><div id="border-br"></div>
			</div>
			<div id="controls">
				Functions: <select id="functions" name="functions">
					<option value="main">main</option>
				</select><br />
				<button id="createFunction" onClick="createFunction()">Create Function</button>
				<button id="deleteFunction" onCLick="deleteFunction()" disabled="true">Delete Function</button><br />
				Instructions:<br />
				<select id="code" multiple>

				</select><br />
				<div style="font-style: italic; font-size: 12px; margin: 0px; padding: 0px; text-align: center;">
					To insert code before a command, select the command<br />
					To append code, <a href="#" onClick="$('#code').val('')">deselect</a> everything
				</div>
				<ul id="commands">
					Move:<br />
					<li><button id="moveLeft" onClick="addCommand(1)"><img alt="Move Left" src="images/cmd_left.png" /></button></li>
					<li><button id="moveRight" onClick="addCommand(2)"><img alt="Move Right" src="images/cmd_right.png" /></button></li>
					<li><button id="moveUp" onClick="addCommand(3)"><img alt="Move Up" src="images/cmd_up.png" /></button></li>
					<li><button id="moveDown" onClick="addCommand(4)"><img alt="Move Down" src="images/cmd_down.png" /></button></li><br />
					Clone:<br />
					<li><button id="cloneLeft" onClick="addCloneCommand(5)"><img alt="Clone Left" src="images/cmd_clone_left.png" /></button></li>
					<li><button id="cloneRight" onClick="addCloneCommand(6)"><img alt="Clone Right" src="images/cmd_clone_right.png" /></button></li>
					<li><button id="cloneUp" onClick="addCloneCommand(7)"><img alt="Clone Up" src="images/cmd_clone_up.png" /></button></li>
					<li><button id="cloneDown" onClick="addCloneCommand(8)"><img alt="Clone Down" src="images/cmd_clone_down.png" /></button></li>
				</ul>
				<div id="commandsExtra">
					Others:<br />
					<button id="doNothing" onClick="addCommand(0)">Do Nothing</button>
					<button id="deleteCommand" onClick="deleteCommands()" disabled="true">Delete Command(s)</button>
					<button id="clearCommands" onClick="clearCommands()">Clear Commands</button>
				</div>
			</div>
		</div>

		<script type="text/javascript">
			var c = document.getElementById("gameCanvas");
			var ctx = c.getContext("2d");
			var mainBot;
			var mainBotCmds = new Array();
			var functions = new Array();
			var branches;
			var input;
			var w = c.width = getWidth(); var h = c.height = getHeight();

			var NOTHING = 0;
			var MOVE_LEFT = 1;
			var MOVE_RIGHT = 2;
			var MOVE_UP = 3;
			var MOVE_DOWN = 4;
			var CLONE_LEFT = 5;
			var CLONE_RIGHT = 6;
			var CLONE_UP = 7;
			var CLONE_DOWN = 8;

			Command = function(id, meta) {
				this.id = id;
				this.meta = meta;
			}

			var cmdText = ["Do Nothing", "Move Left", "Move Right", "Move Up", "Move Down", "Clone Left", "Clone Right", "Clone Up", "Clone Down"];

			var botImg = new Image();
			botImg.src = "images/bot.png";

			function updateButtonDisables() {
				$("#deleteCommand").attr('disabled', !$("#code").val());
				$("#deleteFunction").attr('disabled', $("#functions").val() == "main");
			}

			function populateCommandList() {
				$("#code").html("");
				var cmdList = mainBotCmds;
				if($("#functions").val() != "main")
					cmdList = functions[parseInt($("#functions").val().substring(1))];
				var n = $("#code option").length;
				for(var i = 0; i < cmdList.length; i++) {
					$("#code").append($('<option>', { value: "c" + n, text : cmdText[cmdList[i].id] + (cmdList[i].meta ? " (" + cmdList[i].meta + ")" : "") }));
					n++;
				}
			}

			function createFunction() {
				var name = window.prompt("Function name:", "");
				var validName = (name != "" && name.length < 15);
				if(validName)
					$("#functions option").each(function(i) {
						if($(this).text() == name)
							validName = false;
					});

				if(!validName)
					alert("Invalid name: " + name);
				else {
					var n = $("#functions option").length - 1;
					$("#functions").append($("<option>", { value: "f" + n, text: name}));
					$("#functions").val("f" + n);
					functions.push(new Array());
				}
				updateButtonDisables();
				populateCommandList();
			}

			function deleteFunction() {
				if($("#functions").val() != "main" && window.confirm("Are you sure?")) {
					var n = parseInt($("#functions").val().substring(1));
					functions.splice(n, 1);
					$("#functions :selected").remove();
					$("#functions option").each(function(i) {
						if($(this).val() != "main")
							$(this).val("f" + (i - 1));
					});
				}
				
				updateButtonDisables();
			}

			function addCommand(id) {
				addRawCommand(new Command(id, ""));
			}

			function addCloneCommand(id) {
				var func = window.prompt("Which function would you like to clone into?", "main");
				var valid = func == "main";
				if(!valid)
					$("#functions option").each(function(i) {
						if($(this).text() == func)
							valid = true;
					});

				if(valid)
					addCommand(id, func);
				else
					alert("Invalid function: " + func);
			}

			function addCommand(id, meta) {
				cmd = new Command(id, meta);
				var before = -1;
				if($("#code :selected").length == 1)
					before = parseInt($("#code :selected").val().substring(1));

				if($("#functions").val() == "main") {
					if(before >= 0)
						mainBotCmds.splice(before, 0, cmd);
					else
						mainBotCmds.push(cmd);
				}
				else {
					var n = parseInt($("#functions").val().substring(1));
					if(before >= 0)
						functions[n].splice(before, 0, cmd);
					else
						functions[n].push(cmd);
				}
				populateCommandList();
			}

			function deleteCommands() {
				var n;
				if($("#functions").val() != "main")
					n = parseInt($("#functions").val().substring(1));
				
				var toSplice = new Array();
				$("#code :selected").each(function(num) {
					var i = parseInt($(this).val().substring(1));
					toSplice.push(i - toSplice.length);
				});
				$("#code :selected").remove();
				$("#code option").each(function(i) {
					$(this).val("c" + i);
				});
				
				for(var i = 0; i < toSplice.length; i++) {
					var x = toSplice[i];
					if($("#functions").val() == "main")
						mainBotCmds.splice(x, 1);
					else
						functions[parseInt($("#functions").val().substring(1))].splice(x, 1);
				};

				updateButtonDisables();
			}

			function clearCommands() {
				if($("#functions").val() == "main")
					mainBotCmds = [];
				else
					functions[parseInt($("#functions").val().substring(1))] = [];
				populateCommandList();
			}

			$("#code").change(updateButtonDisables);
			$("#functions").change(function() {
				updateButtonDisables();
				populateCommandList();
			});

			$(document).ready(function() {
				mainBot = new Bot(0, 0);
				branches = new Array();
				input = new Input();

				$(document).keydown(function(e) {
					input.keydown(e);
				});

				$(document).keyup(function(e) {
					input.keyup(e);
				});

				setInterval(gameLoop, 10);

				function onUpdate() {
					
				}

				function draw() {
					ctx.save();
					ctx.fillStyle = "#E0E0E0";
					ctx.fillRect(0, 0, w, h);

					ctx.strokeStyle = "#808080";
					ctx.lineWidth = 1;
					for(var i = 0; i <= cellsH; i++) {
						ctx.beginPath();
						ctx.moveTo(i * cellWidth, 0);
						ctx.lineTo(i * cellWidth, h);
						ctx.stroke();

						ctx.beginPath();
						ctx.moveTo(0, i * cellHeight);
						ctx.lineTo(w, i * cellHeight);
						ctx.stroke();
					}

					ctx.drawImage(botImg, mainBot.x, mainBot.y);

					ctx.restore();
				}

				function gameLoop() {
					onUpdate();
					draw();
				}
			});
			$("document").keypress()
		</script>
	</body>
</html>
